name: Update GitLab 3D Profile

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate-gitlab-3d:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml

      - name: Fetch GitLab contributions and generate 3D graph
        run: |
          python3 << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime, timedelta

          username = "thamle.work"
          
          # Fetch GitLab contribution calendar
          url = f"https://gitlab.com/users/{username}/calendar.json"
          print(f"Fetching GitLab contributions from {url}...")
          
          response = requests.get(url)
          response.raise_for_status()
          gitlab_data = response.json()
          
          total = sum(gitlab_data.values())
          print(f"Found {total} contributions across {len(gitlab_data)} days")
          
          # Convert to format compatible with 3d-contrib
          # Create contributions array
          contributions = []
          for date_str, count in sorted(gitlab_data.items()):
              contributions.append({
                  "date": date_str,
                  "count": count,
                  "level": min(count // 3, 4) if count > 0 else 0
              })
          
          # Save to file for the next step
          os.makedirs('gitlab-data', exist_ok=True)
          with open('gitlab-data/contributions.json', 'w') as f:
              json.dump(contributions, f, indent=2)
          
          print(f"Saved {len(contributions)} contribution records")
          EOF

      - name: Generate 3D contribution graph
        uses: yoshi389111/github-profile-3d-contrib@0.7.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: thamle.work
          SETTING_JSON: 3d-profile-settings-gitlab.json

      - name: Move GitLab graph to separate directory
        run: |
          mkdir -p profile-3d-contrib/gitlab
          if [ -f profile-3d-contrib/profile-customize.svg ]; then
            cp profile-3d-contrib/profile-customize.svg profile-3d-contrib/gitlab/profile-gitlab-3d.svg
            echo "GitLab 3D graph created"
          fi

      - name: Commit and push if changed
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update GitLab 3D contribution graph"
            git push
          fi
